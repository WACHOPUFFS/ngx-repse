<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kardex de Vacaciones</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <!-- Boostrap Icons-->
    
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        td.details-control {
            cursor: pointer;
            text-align: center;
        }

        tr.shown td.details-control i {
            transform: rotate(90deg);
        }
    </style>
</head>

<body>
    <div id="header" style="margin-top: 100px;"></div>

    <div class="container mt-5">

        <!-- Card con sombra y bordes redondeados -->
        <div class="card shadow rounded-4">
            <div class="card-body">
                <h1 class="text-center mb-1">Kardex de Vacaciones</h1>

             
                <!-- Selector de empleado y botón -->
                <div class="row g-3 align-items-center mb-3">
                    <div class="col-md-8">
                        <label for="empleadoId" class="form-label fw-semibold">Selecciona empleado:</label>
                        <div class="input-group">
                            <select id="empleadoId" class="form-select">
                                <option selected>Selecciona un empleado...</option>
                            </select>
                            <button class="btn btn-primary" onclick="generarReporte()">Generar reporte</button>
                        </div>
                    </div>
                </div>

                <!-- Vacaciones tomadas antes de la alta y botón -->
                <div class="row g-3 align-items-center mb-3">
                    <div class="col-md-8">
                        <label for="vacacionesAlta" class="form-label fw-semibold">Vacaciones tomadas antes de la
                            alta:</label>
                        <div class="input-group">
                            <input type="number" id="vacacionesAlta" class="form-control" min="0" value="0">
                            <button class="btn btn-success" onclick="actualizarVacacionesAlta()">Actualizar</button>
                        </div>
                    </div>
                </div>

                <!-- Tabla de vacaciones -->
                <div class="table-responsive">
                    <table id="tablaVacaciones" class="table table-striped table-bordered text-center">
                        <thead class="table-dark">
                            <tr>
                                <th></th> <!-- Ícono de expansión -->
                                <th>Concepto</th>
                                <th>Fecha Registro</th>
                                <th>Fecha Inicio</th>
                                <th>Fecha Fin</th>
                                <th>Tomadas</th>
                                <th>Días Con Derecho</th>
                                <th>Saldo</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap y DataTables JS -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>

fetch('../header.php')
            .then(response => response.text())
            .then(data => {
                document.getElementById('header').innerHTML = data;
            })
            .catch(error => console.error('Error al cargar el header:', error));



        let tabla;

        // Función para formatear fecha y quitar la hora
        function formatearFecha(fecha) {
            return fecha ? fecha.split(' ')[0] : "N/A";
        }

        // Formato de subfila para detalles
        function formatoDetalles(detalleTomados) {
            let html = `<table class="table table-sm table-bordered">
                            <thead><tr><th>Fecha Inicio</th><th>Fecha Fin</th><th>Días Tomados</th></tr></thead>
                            <tbody>`;
            detalleTomados.forEach(detalle => {
                html += `<tr>
                            <td>${formatearFecha(detalle.FechaInicio)}</td>
                            <td>${formatearFecha(detalle.FechaFin)}</td>
                            <td>${detalle.DiasTomados || 0}</td>
                         </tr>`;
            });
            html += `</tbody></table>`;
            return html;
        }

        // Cargar empleados al iniciar
        document.addEventListener("DOMContentLoaded", () => {
            fetch('get_empleados.php')
                .then(res => res.json())
                .then(data => {
                    const select = document.getElementById("empleadoId");
                    data.forEach(emp => {
                        const option = document.createElement("option");
                        option.value = emp.IDEmpleado;
                        option.textContent = emp.NombreCompleto;
                        select.appendChild(option);
                    });
                });
        });

        // Generar el reporte
        function generarReporte() {
            const empleadoId = document.getElementById("empleadoId").value;

            fetch(`get_kardex.php?empleadoId=${empleadoId}`)
                .then(res => res.json())
                .then(data => {
                    const tbody = [];
                    let altaPrimera = true;

                    // Asegurar que las "Vacaciones antes de la alta" estén al inicio
                    data.Vacaciones.sort((a, b) => a.Concepto === "Vacaciones tomadas antes de la alta" ? -1 : 1);

                    data.Vacaciones.forEach((row, index) => {
                        if (row.Concepto === "Vacaciones tomadas antes de la alta" && altaPrimera) {
                            document.getElementById("vacacionesAlta").value = row.Tomadas || 0;
                            altaPrimera = false;
                        }
                        tbody.push({
                            detalles: row.DetalleTomados || [],
                            ...row
                        });
                    });

                    // Crear la tabla
                    if (tabla) tabla.destroy();
                    tabla = $('#tablaVacaciones').DataTable({
                        data: tbody,
                        searching: false,
                        ordering: false,
                        paging: true,
                        columns: [
                            {
                                className: 'details-control',
                                orderable: false,
                                data: null,
                                defaultContent: '<i class="bi bi-chevron-right"></i>'
                            },
                            { data: 'Concepto' },
                            {
                                data: 'FechaRegistro',
                                render: function (data) {
                                    return data ? data : "N/A"; // Valor por defecto si es null o undefined
                                }
                            },
                            {
                                data: 'FechaInicio',
                                render: function (data) {
                                    return data ? data : "N/A";
                                }
                            },
                            {
                                data: 'FechaFin',
                                render: function (data) {
                                    return data ? data : "N/A";
                                }
                            },
                            { data: 'Tomadas' },
                            { data: 'DiasVacaciones' },
                            { data: 'Saldo' }
                        ]
                    });


                    // Expandir/cerrar detalles
                    $('#tablaVacaciones tbody').on('click', 'td.details-control', function () {
                        const tr = $(this).closest('tr');
                        const row = tabla.row(tr);
                        row.child.isShown() ? row.child.hide() : row.child(formatoDetalles(row.data().detalles)).show();
                        tr.toggleClass('shown');
                    });
                });
        }

        // Actualizar vacaciones antes de la alta
        function actualizarVacacionesAlta() {
            const empleadoId = document.getElementById("empleadoId").value;
            const dias = document.getElementById("vacacionesAlta").value;

            fetch('actualizar_vacaciones.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ empleadoId, dias })
            }).then(res => res.json())
                .then(data => {
                    alert(data.success || "Actualizado correctamente");
                    generarReporte();
                });
        }
    </script>
</body>

</html>